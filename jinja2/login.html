<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>{{ login_title }} - login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/static/irmajs-v0.4.2/irma.js"></script>
</head>
<main id="main-content" tabindex="-1">

    <section class="bg-color-offset auth">
        <div>
            <div class="tile options-overview">
                <div id="irma-web-form"></div>
            </div>
        </div>
    </section>
</main>
<script>
    let handleState = function(state){
        console.log(state);
        if(state === "Error"){
            window.location.assign('{{ redirect_url }}?state={{ state }}&error=' + irmaPopup.stateMachine._state);
        }
    }
    let options = {
        // Developer options
        debugging: true,

        // Front-end options
        language:  'en',
        translations: {
            header:  '{{ login_title }} - login',
            loading: 'Just one second please!'
        },

        // Back-end options
        session: {
            start: {
                url: o => `${o.url}` + '/session/{{ exchange_token }}/irma',
            },
            result: false,
            mapping: {
                sessionPtr: r => r,
            },
        },
    };

    const irmaPopup = irma.newPopup({
        ...options,
        element: '#irma-web-form'
    });

    handleState(irmaPopup.stateMachine._state)
    setInterval(function () {
        handleState(irmaPopup.stateMachine._state)
    }, 1000);

    irmaPopup.start()
        .then(() => {
            window.location.assign('{{ redirect_url }}?state={{ state }}');
        })
        .catch((err) => {
            window.location.assign('{{ redirect_url }}?state={{ state }}&error=' + irmaPopup.stateMachine._state);
        });
</script>
</html>
